########################################################################
# Control and Status Register [0]

record(mbbiDirect, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):foutenRAW"){
  field(DESC, "Enable/Disable FANOUT RAW")
  field(NOBT, "1")
  field(DTYP, "stream")
  field(SCAN, "I/O Intr")
  field(INP, "@timing.proto fout_ctrl_en_intr $(PORT)")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):foutenRBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):foutenRBV"){
  field(DESC, "Enable/Disable FANOUT RBV")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):foutenRAW.B0")
}

record(mbbiDirect, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):linkRAW") {
  field(ASG, "Reserved")
  field(DESC, "Uplink status RAW")
  field(NOBT, "8")
  field(DTYP, "stream")
  field(SCAN, "I/O Intr")
  field(INP, "@timing.proto fout_ctrl_link_intr $(PORT)")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):link")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):link") {
  field(ASG, "Reserved")
  field(DESC, "Uplink status")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):linkRAW.B7")
}

record(mbbiDirect, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSRAW") {
  field(ASG, "Reserved")
  field(DESC, "Downlink status in OUT0-OUT7 RAW")
  field(NOBT, "8")
  field(DTYP, "stream")
  field(SCAN, "I/O Intr")
  field(INP, "@timing.proto fout_ctrl_los_intr $(PORT)")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINVCALC")
}

# The downlink status bits are inverted in the FOUT module
# Correct this by inverting the logic

record(calc, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINVCALC"){
  field(ASG, "Reserved")
  field(DESC, "Invert downlink status bits calc")
  field(INPA, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSRAW.VAL")
  field(CALC, "~A")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV")
}

record(mbbiDirect, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV") {
  field(ASG, "Reserved")
  field(DESC, "Inverted downlink status bits")
  field(NOBT, "8")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINVCALC.VAL")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los0RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los0RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT0 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B7")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los1RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los1RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT1 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B6")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los2RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los2RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT2 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B5")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los3RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los3RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT3 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B4")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los4RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los4RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT4 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B3")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los5RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los5RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT5 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B2")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los6RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los6RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT6 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B1")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los7RBV")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):los7RBV"){
  field(ASG, "Reserved")
  field(DESC, "OUT7 downlink status RBV")
  field(ZNAM, "UNLINK")
  field(ONAM, "LINK")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):LOSINV.B0")
}

record(bo, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):fouten"){
  field(DESC, "Enable/Disable FANOUT")
  field(DTYP, "stream")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
  field(OUT, "@timing.proto fout_ctrl_set($(Sec),$(Sub),$(Dis),$(Dev),$(Idx)) $(PORT)")
}

record(longout, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):cmd_ctrl_get") {
  field(ASG, "Reserved")
  field(DESC, "Control Status reg read command code")
  field(VAL, "0x80") # (0x80 | reg number)
  field(SCAN, "1 second")
  field(DTYP, "stream")
  field(OUT, "@timing.proto fout_ctrl_get($(Sec),$(Sub),$(Dis),$(Dev),$(Idx)) $(PORT)")
}

record(longout, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):cmd_ctrl_set") {
  field(ASG, "Reserved")
  field(DESC, "Control Status reg write command code")
  field(VAL, "0x40")
}

########################################################################
# Configuration Register [63]

record(longin, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):alive") {
  field(ASG, "Reserved")
  field(DESC, "FOUT alive")
  field(SCAN, "I/O Intr")
  field(DTYP, "stream")
  field(INP, "@timing.proto fout_conf_alive_intr $(PORT)")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):statdevcalc")
}

record(mbbi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):funselRBV") {
#  field(ASG, "Reserved")
  field(DESC, "STD-EVO function select status")
  field(NOBT, "6")
  field(ZRVL, "16")
  field(ZRST, "FOUT")
  field(ONVL, "17")
  field(ONST, "EVR")
  field(TWVL, "18")
  field(TWST, "EVG")
  field(THVL, "32")
  field(THST, "EVE")
  field(SCAN, "I/O Intr")
  field(DTYP, "stream")
  field(INP, "@timing.proto fout_conf_funsel_intr $(PORT)")
}

record(mbbo, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):funsel") {
  field(DESC, "STD-EVO configuration")
  field(ZRVL, "16")
  field(ZRST, "FOUT")
  field(ONVL, "17")
  field(ONST, "EVR")
  field(TWVL, "18")
  field(TWST, "EVG")
  field(THVL, "32")
  field(THST, "EVE")
  field(VAL, "0")
  field(DTYP, "stream")
  field(OUT, "@timing.proto fout_conf_set($(Sec),$(Sub),$(Dis),$(Dev),$(Idx)) $(PORT)")
}

record(longout, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):cmd_conf_get") {
  field(ASG, "Reserved")
  field(DESC, "Configuration reg read command code")
  field(VAL, "0xBF")
  field(SCAN, "1 second")
  field(DTYP, "stream")
  field(OUT, "@timing.proto fout_conf_get($(Sec),$(Sub),$(Dis),$(Dev),$(Idx)) $(PORT)")
}

record(longout, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):cmd_conf_set") {
  field(ASG, "Reserved")
  field(DESC, "Configuration reg write command code")
  field(VAL, "0x7F")
}

########################################################################
# Write all configuration registers

record(bo, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):download") {
  field(DESC, "FOUT download")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
}

record(bo, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):downloadT") {
  field(DESC, "FOUT download trigger")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
  field(DTYP, "stream")
  field(OUT, "@timing.proto fout_download($(Sec),$(Sub),$(Dis),$(Dev),$(Idx)) $(PORT)")
}

record(calc, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):statdevcalc") {
  field(ASG, "Reserved")
  field(DESC, "FOUT device status calc")
  field(INPA, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):alive")
  field(CALC, "A=0?0:1")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):statdev")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):statdev") {
  field(ASG, "Reserved")
  field(DESC, "FOUT device status")
  field(ZNAM, "WAITING")
  field(ONAM, "RUNNING")
  field(INP, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):statdevcalc")
}

record(bi, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):network") {
  field(ASG, "Reserved")
  field(DESC, "FOUT network status")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
}

record(bo, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):SAVE"){
  field(DESC, "FOUT manual save settings command")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
  field(FLNK, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):save_T")
}

record(calc, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):save_T"){
  field(DESC, "FOUT manual save trigger")
  field(INPA, "$(Sec)-$(Sub):$(Dis)-$(Dev)$(Idx):SAVE.VAL")
  field(CALC, "(A > 0) ? (VAL+1) : VAL")
  field(VAL, "0")
}
